#!/bin/bash

# Detecta o shell e escolhe o arquivo de perfil correto
if [ -n "$ZSH_VERSION" ]; then
  PROFILE_FILE="$HOME/.zshrc"
else
  PROFILE_FILE="$HOME/.bashrc"
fi

# Se NODE_ENV_DK n√£o estiver definido, tenta carregar do perfil
if [ -z "$NODE_ENV_DK" ]; then
  if grep -q "export NODE_ENV_DK=" "$PROFILE_FILE"; then
    NODE_ENV_DK=$(grep "export NODE_ENV_DK=" "$PROFILE_FILE" | cut -d '=' -f2)
    export NODE_ENV_DK
  fi
fi

# Se NODE_VERSION_DK n√£o estiver definido, tenta carregar do perfil
if [ -z "$NODE_VERSION_DK" ]; then
  if grep -q "export NODE_VERSION_DK=" "$PROFILE_FILE"; then
    NODE_VERSION_DK=$(grep "export NODE_VERSION_DK=" "$PROFILE_FILE" | cut -d '=' -f2)
    export NODE_VERSION_DK
  else
    NODE_VERSION_DK="latest"
  fi
fi

# Define o nome do container baseado no valor da vari√°vel
CONTAINER_NAME="${NODE_ENV_DK:-}"

case "$1" in
  start)
    if [ -z "$CONTAINER_NAME" ]; then
      echo "‚ùå Erro: NODE_ENV_DK n√£o est√° definido. Use '$0 set <container-name>' antes."
      exit 1
    fi

    if docker ps -a --format '{{.Names}}' | grep -q "^${CONTAINER_NAME}$"; then
      echo "‚ö° O container '${CONTAINER_NAME}' j√° existe. Iniciando..."
      docker start "${CONTAINER_NAME}"
    else
      echo "üöÄ Criando e iniciando o container '${CONTAINER_NAME}' com Node.js vers√£o '${NODE_VERSION_DK}'..."
      docker run -dit --name "${CONTAINER_NAME}" -v "$PWD":/home/node/app -w /home/node/app -p 3000:3000 node:${NODE_VERSION_DK} bash
    fi
    ;;

  stop)
    if [ -z "$CONTAINER_NAME" ]; then
      echo "‚ùå Erro: NODE_ENV_DK n√£o est√° definido. Use '$0 set <container-name>' antes."
      exit 1
    fi

    echo "üõë Parando o container '${CONTAINER_NAME}'..."
    docker stop "${CONTAINER_NAME}"
    ;;

  remove)
    if [ -z "$CONTAINER_NAME" ]; then
      echo "‚ùå Erro: NODE_ENV_DK n√£o est√° definido. Use '$0 set <container-name>' antes."
      exit 1
    fi

    echo "üî• Removendo o container '${CONTAINER_NAME}'..."
    docker rm "${CONTAINER_NAME}"
    ;;

  status)
    if [ -z "$CONTAINER_NAME" ]; then
      echo "‚ùå Erro: NODE_ENV_DK n√£o est√° definido. Use '$0 set <container-name>' antes."
      exit 1
    fi

    docker ps -a --format "table {{.Names}}\t{{.Status}}" | grep "${CONTAINER_NAME}" || echo "‚ùå O container '${CONTAINER_NAME}' n√£o existe."
    ;;

  shell)
    if [ -z "$CONTAINER_NAME" ]; then
      echo "‚ùå Erro: NODE_ENV_DK n√£o est√° definido. Use '$0 set <container-name>' antes."
      exit 1
    fi

    echo "üîç Abrindo um shell dentro do container '${CONTAINER_NAME}'..."
    docker exec -it "${CONTAINER_NAME}" bash
    ;;

  set)
    if [ -z "$2" ]; then
      echo "‚ùå Erro: Voc√™ deve fornecer um nome para o container."
      echo "Uso: $0 set <container-name>"
      exit 1
    fi

    CONTAINER_NAME="$2"
    export NODE_ENV_DK="$2"

    # Adiciona a vari√°vel ao arquivo de perfil para persist√™ncia
    if grep -q "export NODE_ENV_DK=" "$PROFILE_FILE"; then
      sed -i "s|export NODE_ENV_DK=.*|export NODE_ENV_DK=${CONTAINER_NAME}|" "$PROFILE_FILE"
    else
      echo "export NODE_ENV_DK=${CONTAINER_NAME}" >> "$PROFILE_FILE"
    fi

    echo "‚úÖ Vari√°vel NODE_ENV_DK definida como '${CONTAINER_NAME}' e persistida no ambiente."
    ;;

  set-node-version)
    if [ -z "$2" ]; then
      echo "‚ùå Erro: Voc√™ deve fornecer uma vers√£o do Node.js."
      echo "Uso: $0 set-node-version <vers√£o>"
      exit 1
    fi

    NODE_VERSION_DK="$2"
    export NODE_VERSION_DK="$2"

    # Adiciona a vari√°vel ao arquivo de perfil para persist√™ncia
    if grep -q "export NODE_VERSION_DK=" "$PROFILE_FILE"; then
      sed -i "s|export NODE_VERSION_DK=.*|export NODE_VERSION_DK=${NODE_VERSION_DK}|" "$PROFILE_FILE"
    else
      echo "export NODE_VERSION_DK=${NODE_VERSION_DK}" >> "$PROFILE_FILE"
    fi

    echo "‚úÖ Vers√£o do Node.js definida como '${NODE_VERSION_DK}' e persistida no ambiente."
    ;;

  unset)
    unset NODE_ENV_DK
    sed -i "/export NODE_ENV_DK=/d" "$PROFILE_FILE"
    echo "üóëÔ∏è Vari√°vel NODE_ENV_DK removida."

    unset NODE_VERSION_DK
    sed -i "/export NODE_VERSION_DK=/d" "$PROFILE_FILE"
    echo "üóëÔ∏è Vari√°vel NODE_VERSION_DK removida."
    ;;

  *)
    echo "‚ùå Uso: $0 {start|stop|remove|status|shell|set <container-name>|set-node-version <vers√£o>|unset}"
    exit 1
    ;;
esac
